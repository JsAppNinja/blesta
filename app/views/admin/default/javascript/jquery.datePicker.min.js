/**
 * Copyright (c) 2008 Kelvin Luck (http://www.kelvinluck.com/)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) 
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 **/
(function(e){function n(e){this.ele=e;this.displayedMonth=null;this.displayedYear=null;this.startDate=null;this.endDate=null;this.showYearNavigation=null;this.closeOnSelect=null;this.displayClose=null;this.rememberViewedMonth=null;this.selectMultiple=null;this.numSelectable=null;this.numSelected=null;this.verticalPosition=null;this.horizontalPosition=null;this.verticalOffset=null;this.horizontalOffset=null;this.button=null;this.renderCallback=[];this.selectedDates={};this.inline=null;this.context="#dp-popup";this.settings={}}function r(t){if(t._dpId)return e.event._dpCache[t._dpId];return false}e.fn.extend({renderCalendar:function(t){var n=function(e){return document.createElement(e)};t=e.extend({},e.fn.datePicker.defaults,t);if(t.showHeader!=e.dpConst.SHOW_HEADER_NONE){var r=e(n("tr"));for(var i=Date.firstDayOfWeek;i<Date.firstDayOfWeek+7;i++){var s=i%7;var o=Date.dayNames[s];r.append(jQuery(n("th")).attr({scope:"col",abbr:o,title:o,"class":s==0||s==6?"weekend":"weekday"}).html(t.showHeader==e.dpConst.SHOW_HEADER_SHORT?Date.abbrDayNames[s]:o))}}var u=e(n("table")).attr({cellspacing:0}).addClass("jCalendar").append(t.showHeader!=e.dpConst.SHOW_HEADER_NONE?e(n("thead")).append(r):n("thead"));var a=e(n("tbody"));var f=(new Date).zeroTime();f.setHours(12);var l=t.month==undefined?f.getMonth():t.month;var c=t.year||f.getFullYear();var h=new Date(c,l,1,12,0,0);var p=Date.firstDayOfWeek-h.getDay()+1;if(p>1)p-=7;var d=Math.ceil((-1*p+1+h.getDaysInMonth())/7);h.addDays(p-1);var v=function(n){return function(){if(t.hoverClass){var r=e(this);if(!t.selectWeek){r.addClass(t.hoverClass)}else if(n&&!r.is(".disabled")){r.parent().addClass("activeWeekHover")}}}};var m=function(){if(t.hoverClass){var n=e(this);n.removeClass(t.hoverClass);n.parent().removeClass("activeWeekHover")}};var g=0;while(g++<d){var y=jQuery(n("tr"));var b=t.dpController?h>t.dpController.startDate:false;for(var i=0;i<7;i++){var w=h.getMonth()==l;var E=e(n("td")).text(h.getDate()+"").addClass((w?"current-month ":"other-month ")+(h.isWeekend()?"weekend ":"weekday ")+(w&&h.getTime()==f.getTime()?"today ":"")).data("datePickerDate",h.asString()).hover(v(b),m);y.append(E);if(t.renderCallback){t.renderCallback(E,h,l,c)}h=new Date(h.getFullYear(),h.getMonth(),h.getDate()+1,12,0,0)}a.append(y)}u.append(a);return this.each(function(){e(this).empty().append(u)})},datePicker:function(t){if(!e.event._dpCache)e.event._dpCache=[];t=e.extend({},e.fn.datePicker.defaults,t);return this.each(function(){var r=e(this);var i=true;if(!this._dpId){this._dpId=e.guid++;e.event._dpCache[this._dpId]=new n(this);i=false}if(t.inline){t.createButton=false;t.displayClose=false;t.closeOnSelect=false;r.empty()}var o=e.event._dpCache[this._dpId];o.init(t);if(!i&&t.createButton){o.button=e('<a href="#" class="dp-choose-date" title="'+e.dpText.TEXT_CHOOSE_DATE+'">'+e.dpText.TEXT_CHOOSE_DATE+"</a>").bind("click",function(){r.dpDisplay(this);this.blur();return false});r.after(o.button)}if(!i&&r.is(":text")){r.bind("dateSelected",function(e,t,n){this.value=t.asString()}).bind("change",function(){if(this.value==""){o.clearSelected()}else{var e=Date.fromString(this.value);if(e){o.setSelected(e,true,true)}}});if(t.clickInput){r.bind("click",function(){r.trigger("change");r.dpDisplay()})}var u=Date.fromString(this.value);if(this.value!=""&&u){o.setSelected(u,true,true)}}r.addClass("dp-applied")})},dpSetDisabled:function(e){return t.call(this,"setDisabled",e)},dpSetStartDate:function(e){return t.call(this,"setStartDate",e)},dpSetEndDate:function(e){return t.call(this,"setEndDate",e)},dpGetSelected:function(){var e=r(this[0]);if(e){return e.getSelected()}return null},dpSetSelected:function(e,n,r,i){if(n==undefined)n=true;if(r==undefined)r=true;if(i==undefined)i=true;return t.call(this,"setSelected",Date.fromString(e),n,r,i)},dpSetDisplayedMonth:function(e,n){return t.call(this,"setDisplayedMonth",Number(e),Number(n),true)},dpDisplay:function(e){return t.call(this,"display",e)},dpSetRenderCallback:function(e){return t.call(this,"setRenderCallback",e)},dpSetPosition:function(e,n){return t.call(this,"setPosition",e,n)},dpSetOffset:function(e,n){return t.call(this,"setOffset",e,n)},dpClose:function(){return t.call(this,"_closeCalendar",false,this[0])},dpRerenderCalendar:function(){return t.call(this,"_rerenderCalendar")},_dpDestroy:function(){}});var t=function(e,t,n,i,s){return this.each(function(){var o=r(this);if(o){o[e](t,n,i,s)}})};e.extend(n.prototype,{init:function(e){this.setStartDate(e.startDate);this.setEndDate(e.endDate);this.setDisplayedMonth(Number(e.month),Number(e.year));this.setRenderCallback(e.renderCallback);this.showYearNavigation=e.showYearNavigation;this.closeOnSelect=e.closeOnSelect;this.displayClose=e.displayClose;this.rememberViewedMonth=e.rememberViewedMonth;this.selectMultiple=e.selectMultiple;this.numSelectable=e.selectMultiple?e.numSelectable:1;this.numSelected=0;this.verticalPosition=e.verticalPosition;this.horizontalPosition=e.horizontalPosition;this.hoverClass=e.hoverClass;this.setOffset(e.verticalOffset,e.horizontalOffset);this.inline=e.inline;this.settings=e;if(this.inline){this.context=this.ele;this.display()}},setStartDate:function(e){if(e){if(e instanceof Date){this.startDate=e}else{this.startDate=Date.fromString(e)}}if(!this.startDate){this.startDate=(new Date).zeroTime()}this.setDisplayedMonth(this.displayedMonth,this.displayedYear)},setEndDate:function(e){if(e){if(e instanceof Date){this.endDate=e}else{this.endDate=Date.fromString(e)}}if(!this.endDate){this.endDate=new Date("12/31/2999")}if(this.endDate.getTime()<this.startDate.getTime()){this.endDate=this.startDate}this.setDisplayedMonth(this.displayedMonth,this.displayedYear)},setPosition:function(e,t){this.verticalPosition=e;this.horizontalPosition=t},setOffset:function(e,t){this.verticalOffset=parseInt(e)||0;this.horizontalOffset=parseInt(t)||0},setDisabled:function(t){$e=e(this.ele);$e[t?"addClass":"removeClass"]("dp-disabled");if(this.button){$but=e(this.button);$but[t?"addClass":"removeClass"]("dp-disabled");$but.attr("title",t?"":e.dpText.TEXT_CHOOSE_DATE)}if($e.is(":text")){$e.attr("disabled",t?"disabled":"")}},setDisplayedMonth:function(t,n,r){if(this.startDate==undefined||this.endDate==undefined){return}var i=new Date(this.startDate.getTime());i.setDate(1);var s=new Date(this.endDate.getTime());s.setDate(1);var o;if(!t&&!n||isNaN(t)&&isNaN(n)){o=(new Date).zeroTime();o.setDate(1)}else if(isNaN(t)){o=new Date(n,this.displayedMonth,1)}else if(isNaN(n)){o=new Date(this.displayedYear,t,1)}else{o=new Date(n,t,1)}if(o.getTime()<i.getTime()){o=i}else if(o.getTime()>s.getTime()){o=s}var u=this.displayedMonth;var a=this.displayedYear;this.displayedMonth=o.getMonth();this.displayedYear=o.getFullYear();if(r&&(this.displayedMonth!=u||this.displayedYear!=a)){this._rerenderCalendar();e(this.ele).trigger("dpMonthChanged",[this.displayedMonth,this.displayedYear])}},setSelected:function(t,n,r,i){if(t<this.startDate||t.zeroTime()>this.endDate.zeroTime()){return}var s=this.settings;if(s.selectWeek){t=t.addDays(-(t.getDay()-Date.firstDayOfWeek+7)%7);if(t<this.startDate){return}}if(n==this.isSelected(t)){return}if(this.selectMultiple==false){this.clearSelected()}else if(n&&this.numSelected==this.numSelectable){return}if(r&&(this.displayedMonth!=t.getMonth()||this.displayedYear!=t.getFullYear())){this.setDisplayedMonth(t.getMonth(),t.getFullYear(),true)}this.selectedDates[t.asString()]=n;this.numSelected+=n?1:-1;var o="td."+(t.getMonth()==this.displayedMonth?"current-month":"other-month");var u;e(o,this.context).each(function(){if(e(this).data("datePickerDate")==t.asString()){u=e(this);if(s.selectWeek){u.parent()[n?"addClass":"removeClass"]("selectedWeek")}u[n?"addClass":"removeClass"]("selected")}});e("td",this.context).not(".selected")[this.selectMultiple&&this.numSelected==this.numSelectable?"addClass":"removeClass"]("unselectable");if(i){var s=this.isSelected(t);$e=e(this.ele);var a=Date.fromString(t.asString());$e.trigger("dateSelected",[a,u,s]);$e.trigger("change")}},isSelected:function(e){return this.selectedDates[e.asString()]},getSelected:function(){var e=[];for(var t in this.selectedDates){if(this.selectedDates[t]==true){e.push(Date.fromString(t))}}return e},clearSelected:function(){this.selectedDates={};this.numSelected=0;e("td.selected",this.context).removeClass("selected").parent().removeClass("selectedWeek")},display:function(t){if(e(this.ele).is(".dp-disabled"))return;t=t||this.ele;var n=this;var r=e(t);var i=r.offset();var s;var o;var u;var a;if(n.inline){s=e(this.ele);o={id:"calendar-"+this.ele._dpId,"class":"dp-popup dp-popup-inline"};e(".dp-popup",s).remove();a={}}else{s=e("body");o={id:"dp-popup","class":"dp-popup"};a={top:i.top+n.verticalOffset,left:i.left+n.horizontalOffset};var f=function(t){var r=t.target;var i=e("#dp-popup")[0];while(true){if(r==i){return true}else if(r==document){n._closeCalendar();return false}else{r=e(r).parent()[0]}}};this._checkMouse=f;n._closeCalendar(true);e(document).bind("keydown.datepicker",function(e){if(e.keyCode==27){n._closeCalendar()}})}if(!n.rememberViewedMonth){var l=this.getSelected()[0];if(l){l=new Date(l);this.setDisplayedMonth(l.getMonth(),l.getFullYear(),false)}}s.append(e("<div></div>").attr(o).css(a).append(e("<h2></h2>"),e('<div class="dp-nav-prev"></div>').append(e('<a class="dp-nav-prev-year" href="#" title="'+e.dpText.TEXT_PREV_YEAR+'">&laquo;</a>').bind("click",function(){return n._displayNewMonth.call(n,this,0,-1)}),e('<a class="dp-nav-prev-month" href="#" title="'+e.dpText.TEXT_PREV_MONTH+'">&lsaquo;</a>').bind("click",function(){return n._displayNewMonth.call(n,this,-1,0)})),e('<div class="dp-nav-next"></div>').append(e('<a class="dp-nav-next-year" href="#" title="'+e.dpText.TEXT_NEXT_YEAR+'">&raquo;</a>').bind("click",function(){return n._displayNewMonth.call(n,this,0,1)}),e('<a class="dp-nav-next-month" href="#" title="'+e.dpText.TEXT_NEXT_MONTH+'">&rsaquo;</a>').bind("click",function(){return n._displayNewMonth.call(n,this,1,0)})),e('<div class="dp-calendar"></div>')).bgIframe());var c=this.inline?e(".dp-popup",this.context):e("#dp-popup");if(this.showYearNavigation==false){e(".dp-nav-prev-year, .dp-nav-next-year",n.context).css("display","none")}if(this.displayClose){c.append(e('<a href="#" id="dp-close">'+e.dpText.TEXT_CLOSE+"</a>").bind("click",function(){n._closeCalendar();return false}))}n._renderCalendar();e(this.ele).trigger("dpDisplayed",c);if(!n.inline){if(this.verticalPosition==e.dpConst.POS_BOTTOM){c.css("top",i.top+r.height()-c.height()+n.verticalOffset)}if(this.horizontalPosition==e.dpConst.POS_RIGHT){c.css("left",i.left+r.width()-c.width()+n.horizontalOffset)}e(document).bind("mousedown.datepicker",this._checkMouse)}},setRenderCallback:function(e){if(e==null)return;if(e&&typeof e=="function"){e=[e]}this.renderCallback=this.renderCallback.concat(e)},cellRender:function(t,n,r,i){var s=this.dpController;var o=new Date(n.getTime());t.bind("click",function(){var t=e(this);if(!t.is(".disabled")){s.setSelected(o,!t.is(".selected")||!s.selectMultiple,false,true);if(s.closeOnSelect){if(s.settings.autoFocusNextInput){var n=s.ele;var r=false;e(":input",n.form).each(function(){if(r){e(this).focus();return false}if(this==n){r=true}})}else{try{s.ele.focus()}catch(i){}}s._closeCalendar()}}});if(s.isSelected(o)){t.addClass("selected");if(s.settings.selectWeek){t.parent().addClass("selectedWeek")}}else if(s.selectMultiple&&s.numSelected==s.numSelectable){t.addClass("unselectable")}},_applyRenderCallbacks:function(){var t=this;e("td",this.context).each(function(){for(var n=0;n<t.renderCallback.length;n++){$td=e(this);t.renderCallback[n].apply(this,[$td,Date.fromString($td.data("datePickerDate")),t.displayedMonth,t.displayedYear])}});return},_displayNewMonth:function(t,n,r){if(!e(t).is(".disabled")){this.setDisplayedMonth(this.displayedMonth+n,this.displayedYear+r,true)}t.blur();return false},_rerenderCalendar:function(){this._clearCalendar();this._renderCalendar()},_renderCalendar:function(){e("h2",this.context).html((new Date(this.displayedYear,this.displayedMonth,1)).asString(e.dpText.HEADER_FORMAT));e(".dp-calendar",this.context).renderCalendar(e.extend({},this.settings,{month:this.displayedMonth,year:this.displayedYear,renderCallback:this.cellRender,dpController:this,hoverClass:this.hoverClass}));if(this.displayedYear==this.startDate.getFullYear()&&this.displayedMonth==this.startDate.getMonth()){e(".dp-nav-prev-year",this.context).addClass("disabled");e(".dp-nav-prev-month",this.context).addClass("disabled");e(".dp-calendar td.other-month",this.context).each(function(){var t=e(this);if(Number(t.text())>20){t.addClass("disabled")}});var t=this.startDate.getDate();e(".dp-calendar td.current-month",this.context).each(function(){var n=e(this);if(Number(n.text())<t){n.addClass("disabled")}})}else{e(".dp-nav-prev-year",this.context).removeClass("disabled");e(".dp-nav-prev-month",this.context).removeClass("disabled");var t=this.startDate.getDate();if(t>20){var n=this.startDate.getTime();var r=new Date(n);r.addMonths(1);if(this.displayedYear==r.getFullYear()&&this.displayedMonth==r.getMonth()){e(".dp-calendar td.other-month",this.context).each(function(){var t=e(this);if(Date.fromString(t.data("datePickerDate")).getTime()<n){t.addClass("disabled")}})}}}if(this.displayedYear==this.endDate.getFullYear()&&this.displayedMonth==this.endDate.getMonth()){e(".dp-nav-next-year",this.context).addClass("disabled");e(".dp-nav-next-month",this.context).addClass("disabled");e(".dp-calendar td.other-month",this.context).each(function(){var t=e(this);if(Number(t.text())<14){t.addClass("disabled")}});var t=this.endDate.getDate();e(".dp-calendar td.current-month",this.context).each(function(){var n=e(this);if(Number(n.text())>t){n.addClass("disabled")}})}else{e(".dp-nav-next-year",this.context).removeClass("disabled");e(".dp-nav-next-month",this.context).removeClass("disabled");var t=this.endDate.getDate();if(t<13){var i=new Date(this.endDate.getTime());i.addMonths(-1);if(this.displayedYear==i.getFullYear()&&this.displayedMonth==i.getMonth()){e(".dp-calendar td.other-month",this.context).each(function(){var n=e(this);var r=Number(n.text());if(r<13&&r>t){n.addClass("disabled")}})}}}this._applyRenderCallbacks()},_closeCalendar:function(t,n){if(!n||n==this.ele){e(document).unbind("mousedown.datepicker");e(document).unbind("keydown.datepicker");this._clearCalendar();e("#dp-popup a").unbind();e("#dp-popup").empty().remove();if(!t){e(this.ele).trigger("dpClosed",[this.getSelected()])}}},_clearCalendar:function(){e(".dp-calendar td",this.context).unbind();e(".dp-calendar",this.context).empty()}});e.dpConst={SHOW_HEADER_NONE:0,SHOW_HEADER_SHORT:1,SHOW_HEADER_LONG:2,POS_TOP:0,POS_BOTTOM:1,POS_LEFT:0,POS_RIGHT:1,DP_INTERNAL_FOCUS:"dpInternalFocusTrigger"};e.dpText={TEXT_PREV_YEAR:"Previous year",TEXT_PREV_MONTH:"Previous month",TEXT_NEXT_YEAR:"Next year",TEXT_NEXT_MONTH:"Next month",TEXT_CLOSE:"Close",TEXT_CHOOSE_DATE:"Choose date",HEADER_FORMAT:"mmmm yyyy"};e.dpVersion="$Id$";e.fn.datePicker.defaults={month:undefined,year:undefined,showHeader:e.dpConst.SHOW_HEADER_SHORT,startDate:undefined,endDate:undefined,inline:false,renderCallback:null,createButton:true,showYearNavigation:true,closeOnSelect:true,displayClose:false,selectMultiple:false,numSelectable:Number.MAX_VALUE,clickInput:false,rememberViewedMonth:true,selectWeek:false,verticalPosition:e.dpConst.POS_TOP,horizontalPosition:e.dpConst.POS_LEFT,verticalOffset:0,horizontalOffset:0,hoverClass:"dp-hover",autoFocusNextInput:false};if(e.fn.bgIframe==undefined){e.fn.bgIframe=function(){return this}}e(window).bind("unload",function(){var t=e.event._dpCache||[];for(var n in t){e(t[n].ele)._dpDestroy()}})})(jQuery)